name: Codespace Automation

on:
  workflow_dispatch:  # Permite ejecuci√≥n manual
  schedule:
    - cron: '0 8 * * 1-5'  # Ejecutar d√≠as laborables a las 8 AM

jobs:
  codespace-task:
    runs-on: ubuntu-latest
    steps:
      - name: Listar Codespaces y obtener informaci√≥n
        id: get-codespace-info
        run: |
          echo "Buscando codespace para el repositorio ${{ github.repository }}..."
          
          # Obtener la lista de codespaces
          response=$(curl -s -H "Authorization: token ${{ secrets.PAT }}" \
          "https://api.github.com/user/codespaces")
          
          # Extraer el nombre y el ID del codespace para este repositorio usando jq
          codespace_name=$(echo "$response" | jq -r '.codespaces[] | select(.repository.full_name == "${{ github.repository }}") | .name')
          codespace_id=$(echo "$response" | jq -r '.codespaces[] | select(.repository.full_name == "${{ github.repository }}") | .id')
          
          if [ "$codespace_name" = "null" ] || [ -z "$codespace_name" ]; then
            echo "Error: No se encontr√≥ un codespace para el repositorio ${{ github.repository }}"
            exit 1
          fi
          
          echo "Codespace encontrado: $codespace_name (ID: $codespace_id)"
          echo "codespace_name=$codespace_name" >> $GITHUB_OUTPUT
          echo "codespace_id=$codespace_id" >> $GITHUB_OUTPUT

      - name: Iniciar Codespace usando el nombre
        id: start-codespace
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT }}
          script: |
            // Obtener el nombre del codespace desde las variables de entorno
            const codespaceName = process.env.CODESPACE_NAME;
            
            try {
              console.log(`Iniciando codespace: ${codespaceName}`);
              const response = await github.request(
                'POST /user/codespaces/{codespace_name}/start', {
                  codespace_name: codespaceName
                }
              );
              console.log('Codespace iniciado: ', response.data);
              return response.status;
            } catch (error) {
              console.log('Error iniciando codespace: ', error);
              throw error;
            }
        env:
          CODESPACE_NAME: ${{ steps.get-codespace-info.outputs.codespace_name }}

      - name: Esperar a que el Codespace est√© disponible
        run: |
          echo "Esperando a que el codespace est√© disponible (tiempo m√°ximo: 15 minutos)..."
          CODESPACE_ID="${{ steps.get-codespace-info.outputs.codespace_id }}"
          
          # Aumentar el tiempo de espera a 15 minutos (90 intentos de 10 segundos)
          for i in {1..90}; do
            echo "=== Intento $i de 90 ==="
            echo "Verificando estado del codespace con ID: $CODESPACE_ID"
            
            # Obtener la respuesta completa usando el ID
            response=$(curl -s -H "Authorization: token ${{ secrets.PAT }}" \
            "https://api.github.com/user/codespaces/$CODESPACE_ID")
            
            # Mostrar la respuesta para depuraci√≥n (solo los primeros 200 caracteres)
            echo "Respuesta de la API: ${response:0:200}..."
            
            # Extraer el estado usando jq
            status=$(echo "$response" | jq -r '.state // "unknown"')
            
            echo "Estado del codespace: $status"
            
            if [ "$status" = "Available" ]; then
              echo "‚úÖ Codespace est√° disponible despu√©s de $((i*10)) segundos"
              break
            fi
            
            # Mostrar progreso cada 10 intentos (cada ~1.7 minutos)
            if (( i % 10 == 0 )); then
              elapsed_minutes=$((i/6))
              echo "‚è≥ Tiempo transcurrido: ${elapsed_minutes} minutos"
            fi
            
            echo "Esperando 10 segundos antes del pr√≥ximo intento..."
            sleep 10
          done
          
          if [ "$status" != "Available" ]; then
            echo "‚ùå Error: Codespace no est√° disponible despu√©s de 15 minutos"
            echo "√öltimo estado conocido: $status"
            exit 1
          fi

      - name: Obtener detalles del Codespace
        id: codespace-details
        run: |
          CODESPACE_ID="${{ steps.get-codespace-info.outputs.codespace_id }}"
          response=$(curl -s -H "Authorization: token ${{ secrets.PAT }}" \
          "https://api.github.com/user/codespaces/$CODESPACE_ID")
          
          # Extraer informaci√≥n importante usando jq
          machine_name=$(echo "$response" | jq -r '.machine_display_name // "unknown"')
          created_at=$(echo "$response" | jq -r '.created_at // "unknown"')
          
          echo "machine_name=$machine_name" >> $GITHUB_OUTPUT
          echo "created_at=$created_at" >> $GITHUB_OUTPUT
          echo "Detalles del Codespace:"
          echo "M√°quina: $machine_name"
          echo "Creado: $created_at"

      - name: Ejecutar comandos en el Codespace
        run: |
          echo "Ejecutando comandos en el codespace..."
          CODESPACE_ID="${{ steps.get-codespace-info.outputs.codespace_id }}"
          
          # Comando 1: Navegar al directorio y listar contenido
          echo "üìÇ Ejecutando comando 1: Listar contenido del directorio"
          curl -X POST \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{"command":"cd /workspaces/GLMCookies && ls -la", "working_directory":"/workspaces/GLMCookies"}' \
            "https://api.github.com/user/codespaces/$CODESPACE_ID/commands" || echo "Comando 1 ejecutado"
          
          sleep 5
          
          # Comando 2: Verificar versi√≥n de Python
          echo "üêç Ejecutando comando 2: Verificar versi√≥n de Python"
          curl -X POST \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{"command":"python --version", "working_directory":"/workspaces/GLMCookies"}' \
            "https://api.github.com/user/codespaces/$CODESPACE_ID/commands" || echo "Comando 2 ejecutado"
          
          # Comando 3: Instalar dependencias (si existe requirements.txt)
          echo "üì¶ Ejecutando comando 3: Instalar dependencias"
          curl -X POST \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d '{"command":"pip install -r requirements.txt", "working_directory":"/workspaces/GLMCookies"}' \
            "https://api.github.com/user/codespaces/$CODESPACE_ID/commands" || echo "Comando 3 ejecutado"

      - name: Detener Codespace
        if: always()
        run: |
          CODESPACE_ID="${{ steps.get-codespace-info.outputs.codespace_id }}"
          echo "üõë Deteniendo el codespace..."
          curl -X POST \
            -H "Authorization: token ${{ secrets.PAT }}" \
            -H "Accept: application/vnd.github.v3+json" \
            "https://api.github.com/user/codespaces/$CODESPACE_ID/stop" || echo "Codespace detenido"
