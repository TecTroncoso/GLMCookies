name: Weekly Codespace Automation

on:
  schedule:
    # Ejecuta cada lunes a las 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Permite ejecuciÃ³n manual

env:
  COMMAND_TO_RUN: "npm test" # Reemplaza con el comando que quieres ejecutar

jobs:
  manage-codespace:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          gh --version
        env:
          GITHUB_TOKEN: ${{ secrets.CODESPACES_TOKEN }}

      - name: Detect and Start Codespace
        id: start-codespace
        run: |
          echo "ðŸ” Detecting codespaces for this repository..."
          
          # Obtener el owner y nombre del repo actual
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          
          echo "Repository: $REPO_OWNER/$REPO_NAME"
          
          # Listar todos los codespaces y filtrar por el repositorio actual
          CODESPACE_NAME=$(gh codespace list --json name,repository --jq ".[] | select(.repository == \"$REPO_OWNER/$REPO_NAME\") | .name" | head -n 1)
          
          if [ -z "$CODESPACE_NAME" ]; then
            echo "âŒ No codespace found for this repository"
            echo "Available codespaces:"
            gh codespace list
            exit 1
          fi
          
          echo "âœ… Found codespace: $CODESPACE_NAME"
          echo "CODESPACE_NAME=$CODESPACE_NAME" >> $GITHUB_OUTPUT
          
          # Verificar el estado actual usando API REST
          CURRENT_STATUS=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/user/codespaces/$CODESPACE_NAME" | jq -r '.state' 2>/dev/null || echo "Unknown")
          echo "Current codespace status: $CURRENT_STATUS"
          
          if [ "$CURRENT_STATUS" = "Available" ]; then
            echo "âœ… Codespace is already running"
          else
            echo "ðŸš€ Starting codespace: $CODESPACE_NAME"
            # GitHub CLI no tiene comando 'start', usamos la API REST
            curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/user/codespaces/$CODESPACE_NAME/start" || {
              echo "âŒ Failed to start codespace"
              gh codespace list
              exit 1
            }
            
            # Esperar a que el codespace estÃ© completamente activo
            echo "â³ Waiting for codespace to be ready..."
            sleep 30
            
            # Verificar el estado con reintentos
            for i in {1..6}; do
              # Usar API REST para verificar el estado
              STATUS=$(curl -s \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/user/codespaces/$CODESPACE_NAME" | jq -r '.state' 2>/dev/null || echo "Starting")
              echo "Attempt $i/6 - Codespace status: $STATUS"
              
              if [ "$STATUS" = "Available" ]; then
                echo "âœ… Codespace is ready!"
                break
              fi
              
              if [ $i -eq 6 ]; then
                echo "âŒ Codespace failed to start after multiple attempts"
                exit 1
              fi
              
              echo "â³ Waiting 30 more seconds..."
              sleep 30
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.CODESPACES_TOKEN }}

      - name: Execute command in Codespace
        id: execute-command
        run: |
          CODESPACE_NAME="${{ steps.start-codespace.outputs.CODESPACE_NAME }}"
          echo "ðŸ“‹ Executing command in codespace: $COMMAND_TO_RUN"
          
          # Ejecutar el comando en el codespace usando SSH
          gh codespace ssh --codespace "$CODESPACE_NAME" -- "$COMMAND_TO_RUN"
          
          # Capturar el cÃ³digo de salida
          COMMAND_EXIT_CODE=$?
          echo "Command exit code: $COMMAND_EXIT_CODE"
          
          if [ $COMMAND_EXIT_CODE -eq 0 ]; then
            echo "âœ… Command executed successfully"
          else
            echo "âŒ Command failed with exit code: $COMMAND_EXIT_CODE"
            exit $COMMAND_EXIT_CODE
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.CODESPACES_TOKEN }}

      - name: Stop Codespace
        if: always() # Ejecuta incluso si los pasos anteriores fallan
        run: |
          CODESPACE_NAME="${{ steps.start-codespace.outputs.CODESPACE_NAME }}"
          
          if [ -z "$CODESPACE_NAME" ]; then
            echo "âš ï¸ No codespace name available, skipping stop"
            exit 0
          fi
          
          echo "ðŸ›‘ Stopping codespace: $CODESPACE_NAME"
          # Usar API REST para parar el codespace
          curl -s -X POST \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/user/codespaces/$CODESPACE_NAME/stop" || {
            echo "âš ï¸ Failed to stop codespace, but continuing..."
          }
          
          # Verificar que se haya detenido
          sleep 10
          STATUS=$(curl -s \
            -H "Authorization: Bearer $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/user/codespaces/$CODESPACE_NAME" | jq -r '.state' 2>/dev/null || echo "unknown")
          echo "Final codespace status: $STATUS"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Send notification on failure
        if: failure()
        run: |
          echo "ðŸš¨ Workflow failed! Check the logs for details."
          # AquÃ­ podrÃ­as agregar notificaciones adicionales como Slack, email, etc.
          
      - name: Send success notification
        if: success()
        run: |
          echo "âœ… Weekly codespace automation completed successfully!"
