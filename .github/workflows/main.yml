name: Weekly Codespace Automation

on:
  schedule:
    # Ejecuta cada lunes a las 9:00 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch: # Permite ejecuci√≥n manual

env:
  COMMAND_TO_RUN: "cd /workspaces/GLMCookies && python main.py" # Fixed path

jobs:
  manage-codespace:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup GitHub CLI
        run: |
          gh --version
        env:
          GITHUB_TOKEN: ${{ secrets.CODESPACES_TOKEN }}

      - name: Detect and Start Codespace
        id: start-codespace
        run: |
          echo "üîç Detecting codespaces for this repository..."
          
          # Obtener el owner y nombre del repo actual
          REPO_OWNER="${{ github.repository_owner }}"
          REPO_NAME="${{ github.event.repository.name }}"
          
          echo "Repository: $REPO_OWNER/$REPO_NAME"
          
          # Listar todos los codespaces y filtrar por el repositorio actual
          CODESPACE_NAME=$(gh codespace list --json name,repository --jq ".[] | select(.repository == \"$REPO_OWNER/$REPO_NAME\") | .name" | head -n 1)
          
          if [ -z "$CODESPACE_NAME" ]; then
            echo "‚ùå No codespace found for this repository"
            echo "Available codespaces:"
            gh codespace list
            exit 1
          fi
          
          echo "‚úÖ Found codespace: $CODESPACE_NAME"
          echo "CODESPACE_NAME=$CODESPACE_NAME" >> $GITHUB_OUTPUT
          
          # Verificar el estado actual usando gh codespace list
          CURRENT_STATUS=$(gh codespace list --json name,state --jq ".[] | select(.name == \"$CODESPACE_NAME\") | .state")
          echo "Current codespace status: $CURRENT_STATUS"
          
          if [ "$CURRENT_STATUS" = "Available" ]; then
            echo "‚úÖ Codespace is already running"
          else
            echo "üöÄ Starting codespace: $CODESPACE_NAME"
            # Usar gh codespace start si est√° disponible, sino usar API REST
            if ! gh codespace start --codespace "$CODESPACE_NAME" 2>/dev/null; then
              echo "Using API REST to start codespace..."
              curl -s -X POST \
                -H "Authorization: Bearer $GITHUB_TOKEN" \
                -H "Accept: application/vnd.github+json" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/user/codespaces/$CODESPACE_NAME/start" || {
                echo "‚ùå Failed to start codespace"
                gh codespace list
                exit 1
              }
            fi
            
            # Esperar a que el codespace est√© completamente activo
            echo "‚è≥ Waiting for codespace to be ready..."
            sleep 30
            
            # Verificar el estado con reintentos
            for i in {1..6}; do
              STATUS=$(gh codespace list --json name,state --jq ".[] | select(.name == \"$CODESPACE_NAME\") | .state")
              echo "Attempt $i/6 - Codespace status: $STATUS"
              
              if [ "$STATUS" = "Available" ]; then
                echo "‚úÖ Codespace is ready!"
                break
              fi
              
              if [ $i -eq 6 ]; then
                echo "‚ùå Codespace failed to start after multiple attempts"
                exit 1
              fi
              
              echo "‚è≥ Waiting 30 more seconds..."
              sleep 30
            done
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.CODESPACES_TOKEN }}

      - name: Verify Codespace File Structure
        id: verify-files
        run: |
          CODESPACE_NAME="${{ steps.start-codespace.outputs.CODESPACE_NAME }}"
          echo "üìÅ Checking file structure in codespace..."
          
          # Verificar la estructura de archivos
          gh codespace ssh --codespace "$CODESPACE_NAME" -- "pwd && ls -la"
          
          # Verificar si main.py existe en diferentes ubicaciones
          echo "üîç Searching for main.py..."
          gh codespace ssh --codespace "$CODESPACE_NAME" -- "find /workspaces -name 'main.py' 2>/dev/null || echo 'main.py not found in /workspaces'"
          gh codespace ssh --codespace "$CODESPACE_NAME" -- "find /home/vscode -name 'main.py' 2>/dev/null || echo 'main.py not found in /home/vscode'"
        env:
          GITHUB_TOKEN: ${{ secrets.CODESPACES_TOKEN }}

      - name: Execute command in Codespace
        id: execute-command
        run: |
          CODESPACE_NAME="${{ steps.start-codespace.outputs.CODESPACE_NAME }}"
          echo "üìã Executing command in codespace: $COMMAND_TO_RUN"
          
          # Verificar si el archivo existe antes de ejecutar
          if gh codespace ssh --codespace "$CODESPACE_NAME" -- "test -f /workspaces/GLMCookies/main.py"; then
            echo "‚úÖ main.py found, executing command..."
            gh codespace ssh --codespace "$CODESPACE_NAME" -- "$COMMAND_TO_RUN"
          elif gh codespace ssh --codespace "$CODESPACE_NAME" -- "test -f /home/vscode/main.py"; then
            echo "‚úÖ main.py found in home directory, adjusting command..."
            gh codespace ssh --codespace "$CODESPACE_NAME" -- "cd /home/vscode && python main.py"
          else
            echo "‚ùå main.py not found in expected locations"
            echo "Available files:"
            gh codespace ssh --codespace "$CODESPACE_NAME" -- "ls -la /workspaces/ 2>/dev/null || true"
            gh codespace ssh --codespace "$CODESPACE_NAME" -- "ls -la /home/vscode/ 2>/dev/null || true"
            exit 1
          fi
          
          # Capturar el c√≥digo de salida
          COMMAND_EXIT_CODE=$?
          echo "Command exit code: $COMMAND_EXIT_CODE"
          
          if [ $COMMAND_EXIT_CODE -eq 0 ]; then
            echo "‚úÖ Command executed successfully"
          else
            echo "‚ùå Command failed with exit code: $COMMAND_EXIT_CODE"
            exit $COMMAND_EXIT_CODE
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.CODESPACES_TOKEN }}

      - name: Stop Codespace
        if: always() # Ejecuta incluso si los pasos anteriores fallan
        run: |
          CODESPACE_NAME="${{ steps.start-codespace.outputs.CODESPACE_NAME }}"
          
          if [ -z "$CODESPACE_NAME" ]; then
            echo "‚ö†Ô∏è No codespace name available, skipping stop"
            exit 0
          fi
          
          echo "üõë Stopping codespace: $CODESPACE_NAME"
          
          # Intentar usar gh codespace stop primero
          if gh codespace stop --codespace "$CODESPACE_NAME" 2>/dev/null; then
            echo "‚úÖ Codespace stopped using GitHub CLI"
          else
            echo "‚ö†Ô∏è GitHub CLI stop failed, trying API REST..."
            # Usar API REST para parar el codespace
            RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/user/codespaces/$CODESPACE_NAME/stop")
            
            if echo "$RESPONSE" | jq -e '.message' >/dev/null 2>&1; then
              echo "‚ö†Ô∏è API Response: $RESPONSE"
              echo "‚ö†Ô∏è Failed to stop codespace via API, but continuing..."
            else
              echo "‚úÖ Codespace stop requested via API"
            fi
          fi
          
          # Verificar que se haya detenido
          sleep 10
          STATUS=$(gh codespace list --json name,state --jq ".[] | select(.name == \"$CODESPACE_NAME\") | .state" || echo "unknown")
          echo "Final codespace status: $STATUS"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Use consistent token

      - name: Send notification on failure
        if: failure()
        run: |
          echo "üö® Workflow failed! Check the logs for details."
          # Aqu√≠ podr√≠as agregar notificaciones adicionales como Slack, email, etc.
          
      - name: Send success notification
        if: success()
        run: |
          echo "‚úÖ Weekly codespace automation completed successfully!"

